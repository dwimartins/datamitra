<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mitra Database System v3.9</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'JetBrains Mono', monospace; }
        
        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: #0f172a; }
        ::-webkit-scrollbar-thumb { background: #4f46e5; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #6366f1; }

        .glass {
            background: rgba(30, 41, 59, 0.7);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .modal-enter { animation: fadeIn 0.3s ease-out forwards; }
        @keyframes fadeIn { from { opacity: 0; transform: scale(0.95); } to { opacity: 1; transform: scale(1); } }

        /* Row Styles */
        .row-contacted { opacity: 0.6; background: rgba(16, 185, 129, 0.05); } 
        .row-new { background: rgba(239, 68, 68, 0.02); }
        .row-selected { background: rgba(99, 102, 241, 0.2) !important; border-left: 2px solid #6366f1; }

        /* Helpers */
        .no-select { user-select: none; cursor: default; }
        .selectable { user-select: text; cursor: text; }
        ::selection { background: rgba(99, 102, 241, 0.5); color: white; }
        input[type="checkbox"] { accent-color: #4f46e5; cursor: pointer; width: 14px; height: 14px; }
        
        /* Tab Active State */
        .tab-active { border-bottom: 2px solid #6366f1; color: white; }
        .tab-inactive { color: #94a3b8; border-bottom: 2px solid transparent; }

        /* Contribution Grid Tooltip */
        .contrib-cell:hover::after {
            content: attr(data-title);
            position: absolute;
            bottom: 100%;
            left: 50%;
            transform: translateX(-50%);
            background: #1e293b;
            color: white;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 10px;
            white-space: nowrap;
            z-index: 10;
            border: 1px solid #4f46e5;
            pointer-events: none;
        }

        /* Hover Actions Logic (General for both columns) */
        .cell-container .hover-actions {
            display: none;
        }
        .cell-container:hover .hover-actions {
            display: flex;
        }
    </style>
</head>
<body class="bg-[conic-gradient(at_top_right,_var(--tw-gradient-stops))] from-slate-900 via-indigo-950 to-slate-900 text-indigo-100 min-h-screen p-4 md:p-8">

    <!-- FLOATING ACTION BAR -->
    <div id="selectionActionBar" class="fixed bottom-6 right-6 bg-slate-800 text-white p-2 rounded-xl shadow-[0_0_30px_rgba(0,0,0,0.5)] border border-indigo-500/50 hidden z-50 flex flex-col gap-2 min-w-[200px] transition-all transform translate-y-2">
        <div class="flex items-center justify-between px-2 pb-2 border-b border-white/10">
            <span class="text-xs font-bold text-indigo-300">TERPILIH: <span id="selCountVal" class="text-white text-lg ml-1">0</span></span>
            <button onclick="clearSelection()" class="text-[10px] text-slate-400 hover:text-white">Batal</button>
        </div>
        <div class="flex gap-2">
            <button onclick="bulkDelete()" class="flex-1 bg-red-600 hover:bg-red-500 text-white py-2 px-3 rounded-lg text-xs font-bold transition-colors flex items-center justify-center gap-1">üóë HAPUS</button>
            <button onclick="bulkToggleStatus()" class="flex-1 bg-emerald-600 hover:bg-emerald-500 text-white py-2 px-3 rounded-lg text-xs font-bold transition-colors flex items-center justify-center gap-1">‚úì STATUS</button>
        </div>
    </div>

    <!-- Header -->
    <div class="max-w-[95%] mx-auto mb-4 flex justify-between items-center border-b border-indigo-500/30 pb-3">
        <div>
            <h1 class="text-2xl font-bold text-transparent bg-clip-text bg-gradient-to-r from-indigo-400 to-cyan-400 tracking-tighter">
                >> MITRA_DB_SYS <span class="text-[10px] align-middle text-emerald-400 border border-emerald-500 px-1 rounded ml-2">V3.9_INDEPENDENT_COPY</span>
            </h1>
            <p class="text-[10px] text-indigo-300/60">Mass Data Injection & Verification Protocol</p>
        </div>
        <div class="text-right flex items-center gap-4">
            <button onclick="openProgressModal()" class="bg-indigo-600 hover:bg-indigo-500 text-white px-3 py-1.5 rounded-lg text-xs font-bold shadow-[0_0_15px_rgba(99,102,241,0.4)] transition-all flex items-center gap-2 border border-indigo-400/30">
                üìä VIEW PROGRESS
            </button>
            <div class="hidden md:block text-right">
                <div id="clock" class="text-lg font-bold text-indigo-400">00:00:00</div>
                <div class="text-[10px] text-indigo-500">SYSTEM READY</div>
            </div>
        </div>
    </div>

    <!-- Layout Utama -->
    <div class="max-w-[95%] mx-auto flex flex-col gap-6 pb-10">
        
        <!-- BAGIAN 1: INPUT & SIDE PANEL (TABS) -->
        <div class="w-full grid grid-cols-1 lg:grid-cols-3 gap-6">
            
            <!-- FORM INPUT (2/3 Layar) -->
            <div class="lg:col-span-2 glass p-5 rounded-xl shadow-2xl shadow-indigo-900/20 relative overflow-hidden group">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-sm font-bold text-white flex items-center gap-2">
                        <span class="w-1.5 h-4 bg-indigo-500 rounded-full"></span> 
                        BULK ENTRY (INPUT)
                    </h2>
                    <button id="clearBtn" class="text-[10px] text-red-400 hover:text-red-300 underline">Clear Forms</button>
                </div>

                <form id="mitraForm" class="space-y-4">
                    <div class="bg-indigo-900/30 p-2 rounded-lg border border-indigo-500/30">
                        <input type="text" id="generalLoc" required placeholder="Lokasi Wilayah (Kec/Kab) untuk data ini..." 
                            class="w-full bg-slate-900 border border-indigo-500/50 rounded p-2 text-xs text-white focus:outline-none focus:border-cyan-400 placeholder-slate-600 transition-all">
                    </div>
                    <div class="space-y-1">
                        <label class="text-[10px] font-bold text-indigo-300 uppercase flex justify-between">
                            <span>PASTE DATA DARI EXCEL (NAMA & WA)</span> <span class="text-slate-500">Lines: <span id="countRaw" class="text-white">0</span></span>
                        </label>
                        <textarea id="smartRawData" rows="8" placeholder="Paste data Nama dan WA di sini..." class="w-full bg-slate-900/80 border border-indigo-500/30 rounded-lg p-3 text-xs focus:border-indigo-400 focus:outline-none text-emerald-50 resize-none whitespace-pre font-mono placeholder-slate-600"></textarea>
                    </div>
                    <div class="space-y-1">
                        <label class="text-[10px] font-bold text-indigo-300 uppercase flex justify-between">
                            <span>Link Maps (Opsional)</span> <span class="text-slate-500">Lines: <span id="countMaps" class="text-white">0</span></span>
                        </label>
                        <textarea id="bulkMaps" rows="3" placeholder="https://maps..." class="w-full bg-slate-900/80 border border-indigo-500/30 rounded-lg p-3 text-xs focus:border-indigo-400 focus:outline-none text-purple-50 resize-none whitespace-pre font-mono"></textarea>
                    </div>
                    <button type="submit" id="btnSubmit" class="w-full group relative overflow-hidden rounded-lg bg-gradient-to-r from-indigo-600 to-cyan-600 p-2.5 text-white font-bold shadow-lg shadow-indigo-600/30 transition-all hover:scale-[1.01] disabled:opacity-50 disabled:cursor-not-allowed">
                        <span id="btnText" class="text-xs uppercase tracking-widest">INJECT DATA üöÄ</span>
                    </button>
                </form>
                <div id="statusBox" class="mt-3 p-3 rounded-lg text-[10px] font-mono hidden max-h-32 overflow-y-auto border shadow-inner"></div>
            </div>

            <!-- RIGHT PANEL: TABS (DEFAULT: NOTES) -->
            <div class="lg:col-span-1 glass p-5 rounded-xl border border-indigo-500/20 flex flex-col h-full min-h-[450px]">
                
                <!-- Tab Headers (Notes First) -->
                <div class="flex border-b border-indigo-500/30 mb-4">
                    <button onclick="switchTab('notes')" id="tabNotes" class="flex-1 py-2 text-[10px] uppercase font-bold transition-all tab-active">DAILY NOTES</button>
                    <button onclick="switchTab('batch')" id="tabBatch" class="flex-1 py-2 text-[10px] uppercase font-bold transition-all tab-inactive">BATCH HISTORY</button>
                </div>

                <!-- Content 1: Daily Notes (Default Visible) -->
                <div id="panelNotes" class="flex-1 flex flex-col overflow-hidden">
                    <form id="noteForm" class="mb-3 flex gap-2">
                        <input type="text" id="noteInput" required placeholder="Tulis catatan harian..." 
                            class="flex-1 bg-slate-900 border border-indigo-500/30 rounded p-2 text-xs text-white focus:border-cyan-400 outline-none">
                        <button type="submit" class="bg-indigo-600 hover:bg-indigo-500 text-white px-3 rounded text-xs font-bold shadow-lg">ADD</button>
                    </form>
                    <div id="notesList" class="flex-grow overflow-y-auto pr-1 space-y-2">
                        <p class="text-[10px] text-slate-500 italic text-center mt-10">Memuat catatan...</p>
                    </div>
                </div>

                <!-- Content 2: Batch List (Hidden) -->
                <div id="panelBatch" class="hidden flex-1 flex flex-col overflow-hidden">
                    <div class="flex justify-between items-center mb-2">
                        <span class="text-[9px] text-indigo-400 uppercase">Input History</span>
                        <span id="batchDateLabel" class="text-[9px] text-slate-500 font-mono"></span>
                    </div>
                    <div class="flex-grow overflow-y-auto pr-1" id="batchListContainer">
                        <p class="text-[10px] text-slate-500 italic text-center mt-10">Pilih filter tanggal untuk melihat batch.</p>
                    </div>
                </div>

            </div>
        </div>

        <!-- BAGIAN 2: DATABASE VIEW (RANGE FILTER) -->
        <div class="w-full">
            <div class="glass p-5 rounded-xl min-h-[500px] flex flex-col border border-indigo-500/20">
                <div class="flex flex-col md:flex-row justify-between items-end md:items-center mb-4 gap-4">
                    <div>
                        <h2 class="text-sm font-bold text-white tracking-wide">DATABASE MONITOR</h2>
                        <p class="text-[10px] text-indigo-300/60" id="viewModeText">Menampilkan data 3 hari terakhir</p>
                    </div>
                    <div class="flex flex-wrap items-center gap-2 justify-end bg-slate-900/50 p-1.5 rounded-lg border border-indigo-500/30">
                        <span class="text-[10px] text-indigo-300 uppercase font-bold ml-1">Range:</span>
                        <input type="date" id="filterStartDate" class="bg-slate-800 border border-indigo-500/30 rounded p-1 text-xs text-white focus:outline-none focus:border-cyan-500 shadow-inner w-28">
                        <span class="text-slate-500 text-xs">-</span>
                        <input type="date" id="filterEndDate" class="bg-slate-800 border border-indigo-500/30 rounded p-1 text-xs text-white focus:outline-none focus:border-cyan-500 shadow-inner w-28">
                        <button onclick="applyDateFilter()" class="text-[10px] bg-indigo-600 px-3 py-1 rounded hover:bg-indigo-500 text-white transition-colors shadow-lg">Cari</button>
                        <button onclick="resetTo3Days()" class="text-[10px] bg-slate-700 px-3 py-1 rounded hover:bg-slate-600 text-white transition-colors ml-1">Reset</button>
                    </div>
                </div>

                <div class="overflow-x-auto rounded-lg border border-indigo-500/20 bg-slate-900/50">
                    <table class="w-full text-left text-xs" id="dataTable">
                        <thead class="bg-indigo-950/90 text-indigo-200 border-b border-indigo-500/30">
                            <tr>
                                <th class="p-2 w-8 text-center no-select"><input type="checkbox" id="checkAll" onchange="toggleSelectAll(this)"></th>
                                <th class="p-2 font-bold w-10 text-center no-select">No.</th>
                                <th class="p-2 font-bold text-center w-12 no-select">Sts</th>
                                <th class="p-2 font-bold whitespace-nowrap no-select">Waktu</th>
                                <th class="p-2 font-bold no-select">Lokasi</th>
                                <!-- KOLOM NAMA (SEKARANG BISA DIBLOK & ADA ACTION) -->
                                <th class="p-2 font-bold selectable text-indigo-300 border-l border-indigo-500/10">Nama Usaha</th>
                                <!-- KOLOM WA (BISA DIBLOK & ADA ACTION) -->
                                <th class="p-2 font-bold selectable text-indigo-300 border-r border-indigo-500/10">Kontak (WA)</th>
                                <th class="p-2 font-bold text-center w-32 no-select">Aksi</th>
                            </tr>
                        </thead>
                        <tbody id="tableBody" class="divide-y divide-indigo-500/10 text-slate-300"></tbody>
                    </table>
                </div>
                
                <div class="mt-3 flex justify-between items-center text-[10px] text-indigo-400 px-1">
                    <span id="totalDataCount">Total Row: 0</span>
                    <button onclick="window.loadData()" class="hover:text-white transition-colors bg-indigo-500/20 hover:bg-indigo-500/40 px-3 py-1 rounded border border-indigo-500/30">‚Üª Refresh</button>
                </div>
            </div>
        </div>
    </div>

    <!-- MODAL CONTRIBUTION PROGRESS -->
    <div id="progressModal" class="hidden fixed inset-0 z-50 flex items-center justify-center bg-black/90 backdrop-blur-md p-4">
        <div class="glass p-8 rounded-2xl w-full max-w-5xl modal-enter border border-indigo-500/40 shadow-[0_0_100px_rgba(79,70,229,0.2)]">
            <div class="flex justify-between items-center mb-6">
                <h3 class="text-xl font-bold text-white flex items-center gap-3">
                    <span class="text-2xl">üìä</span> CONTRIBUTION ACTIVITY
                </h3>
                <button onclick="document.getElementById('progressModal').classList.add('hidden')" class="text-slate-400 hover:text-white text-2xl">&times;</button>
            </div>

            <!-- Stats Cards -->
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-8">
                <div class="bg-indigo-900/30 border border-indigo-500/30 p-4 rounded-xl text-center">
                    <div class="text-[10px] text-indigo-300 uppercase tracking-widest mb-1">7 HARI TERAKHIR</div>
                    <div class="text-3xl font-bold text-white" id="statWeek">0</div>
                    <div class="text-[10px] text-slate-500">Data Masuk</div>
                </div>
                <div class="bg-indigo-900/30 border border-indigo-500/30 p-4 rounded-xl text-center">
                    <div class="text-[10px] text-indigo-300 uppercase tracking-widest mb-1">BULAN INI</div>
                    <div class="text-3xl font-bold text-cyan-400" id="statMonth">0</div>
                    <div class="text-[10px] text-slate-500">Data Masuk</div>
                </div>
                <div class="bg-indigo-900/30 border border-indigo-500/30 p-4 rounded-xl text-center">
                    <div class="text-[10px] text-indigo-300 uppercase tracking-widest mb-1">TAHUN INI</div>
                    <div class="text-3xl font-bold text-emerald-400" id="statYear">0</div>
                    <div class="text-[10px] text-slate-500">Total Kontribusi</div>
                </div>
            </div>

            <!-- Heatmap -->
            <div class="bg-slate-900/80 border border-indigo-500/20 p-6 rounded-xl overflow-x-auto">
                <h4 class="text-xs font-bold text-slate-400 mb-4 uppercase">Keaktifan Input Data (1 Tahun Terakhir)</h4>
                <div class="flex gap-1" id="contributionGraph"></div>
                <div class="flex items-center gap-2 mt-4 text-[10px] text-slate-500 justify-end">
                    <span>Less</span>
                    <div class="w-3 h-3 rounded-sm bg-slate-800 border border-slate-700"></div>
                    <div class="w-3 h-3 rounded-sm bg-indigo-900 border border-indigo-800"></div>
                    <div class="w-3 h-3 rounded-sm bg-indigo-700 border border-indigo-600"></div>
                    <div class="w-3 h-3 rounded-sm bg-indigo-500 border border-indigo-400"></div>
                    <div class="w-3 h-3 rounded-sm bg-cyan-400 shadow-[0_0_5px_cyan]"></div>
                    <span>More</span>
                </div>
            </div>
        </div>
    </div>

    <!-- MODAL EDIT -->
    <div id="editModal" class="hidden fixed inset-0 z-50 flex items-center justify-center bg-black/80 backdrop-blur-sm p-4">
        <div class="glass p-6 rounded-2xl w-full max-w-md modal-enter border border-indigo-500/40 shadow-[0_0_50px_rgba(79,70,229,0.3)]">
            <h3 class="text-lg font-bold text-white mb-4 flex items-center gap-2">‚úèÔ∏è EDIT DATA MITRA</h3>
            <form id="editForm" class="space-y-3">
                <input type="hidden" id="editWaId">
                <div><label class="text-[10px] text-indigo-300 uppercase">Nama Usaha</label><input type="text" id="editNama" class="w-full bg-slate-900 border border-indigo-500/30 rounded p-2 text-xs text-white focus:border-cyan-400 outline-none"></div>
                <div><label class="text-[10px] text-indigo-300 uppercase">Lokasi Wilayah</label><input type="text" id="editLokasi" class="w-full bg-slate-900 border border-indigo-500/30 rounded p-2 text-xs text-white focus:border-cyan-400 outline-none"></div>
                <div><label class="text-[10px] text-indigo-300 uppercase">Link Maps</label><textarea id="editMaps" rows="3" class="w-full bg-slate-900 border border-indigo-500/30 rounded p-2 text-xs text-white focus:border-cyan-400 outline-none resize-none"></textarea></div>
                <div class="flex gap-2 pt-2"><button type="button" id="closeModal" class="flex-1 bg-slate-700 hover:bg-slate-600 text-white py-2 rounded text-xs font-bold">BATAL</button><button type="submit" class="flex-1 bg-indigo-600 hover:bg-indigo-500 text-white py-2 rounded text-xs font-bold shadow-lg">SIMPAN</button></div>
            </form>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js";
        import { getDatabase, ref, set, get, child, remove, update, push } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-database.js";

        const firebaseConfig = {
            apiKey: "AIzaSyAGCiDwE1ccJUE1-jI8P1OvUtcuuTpqZHE",
            authDomain: "data-mitra-42dee.firebaseapp.com",
            databaseURL: "https://data-mitra-42dee-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "data-mitra-42dee",
            storageBucket: "data-mitra-42dee.firebasestorage.app",
            messagingSenderId: "411327733395",
            appId: "1:411327733395:web:5f6cc5ef2d07bf15957766"
        };

        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);

        // --- GLOBAL STATE ---
        let renderedItems = []; 
        let selectedIds = new Set();
        let lastCheckedIndex = null;
        let allDataCache = []; // Cache semua data untuk keperluan statistik

        // --- UTILITIES ---
        function sanitizePhoneNumber(phone) { if(!phone) return ""; return phone.replace(/\D/g, ''); }
        function getTodayDate() { return new Date().toISOString().split('T')[0]; }
        setInterval(() => { document.getElementById('clock').innerText = new Date().toLocaleTimeString('id-ID'); }, 1000);

        // --- TAB SWITCHING ---
        window.switchTab = (tabName) => {
            const panelBatch = document.getElementById('panelBatch');
            const panelNotes = document.getElementById('panelNotes');
            const tabBatch = document.getElementById('tabBatch');
            const tabNotes = document.getElementById('tabNotes');

            if(tabName === 'batch') {
                panelBatch.classList.remove('hidden');
                panelNotes.classList.add('hidden');
                tabBatch.className = "flex-1 py-2 text-[10px] uppercase font-bold transition-all tab-active";
                tabNotes.className = "flex-1 py-2 text-[10px] uppercase font-bold transition-all tab-inactive";
            } else {
                panelBatch.classList.add('hidden');
                panelNotes.classList.remove('hidden');
                tabBatch.className = "flex-1 py-2 text-[10px] uppercase font-bold transition-all tab-inactive";
                tabNotes.className = "flex-1 py-2 text-[10px] uppercase font-bold transition-all tab-active";
                loadNotes();
            }
        };

        // --- NOTES LOGIC ---
        document.getElementById('noteForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const input = document.getElementById('noteInput');
            const text = input.value.trim();
            if(!text) return;
            try { await push(ref(db, 'notes'), { text: text, timestamp: Date.now() }); input.value = ''; loadNotes(); } catch(e) { alert(e.message); }
        });

        window.deleteNote = async (key) => {
            if(confirm('Hapus catatan?')) { try { await remove(ref(db, `notes/${key}`)); loadNotes(); } catch(e) {} }
        };

        async function loadNotes() {
            const list = document.getElementById('notesList');
            list.innerHTML = `<p class="text-[10px] text-slate-500 italic text-center">Loading...</p>`;
            try {
                const snapshot = await get(ref(db, 'notes'));
                list.innerHTML = '';
                if(snapshot.exists()) {
                    const notes = [];
                    snapshot.forEach(child => { notes.push({ key: child.key, ...child.val() }); });
                    notes.sort((a,b) => b.timestamp - a.timestamp);
                    const recentNotes = notes.filter(n => n.timestamp > (Date.now() - (7 * 24 * 3600000)));
                    if(recentNotes.length === 0) { list.innerHTML = `<p class="text-[10px] text-slate-500 italic text-center">Kosong (7 hari terakhir).</p>`; return; }
                    recentNotes.forEach(n => {
                        const d = new Date(n.timestamp);
                        list.insertAdjacentHTML('beforeend', `<div class="bg-indigo-900/20 border border-indigo-500/20 p-2 rounded group relative"><div class="flex justify-between"><span class="text-[9px] text-indigo-400 font-mono">${d.toLocaleDateString('id-ID')}</span><button onclick="deleteNote('${n.key}')" class="text-red-400 hidden group-hover:block text-[9px]">‚úï</button></div><p class="text-xs text-white whitespace-pre-wrap">${n.text}</p></div>`);
                    });
                } else { list.innerHTML = `<p class="text-[10px] text-slate-500 italic text-center">Belum ada catatan.</p>`; }
            } catch(e) {}
        }

        // --- PROGRESS & CONTRIBUTION GRAPH ---
        window.openProgressModal = async () => {
            document.getElementById('progressModal').classList.remove('hidden');
            
            // Hitung Statistik
            const today = new Date();
            let weekCount = 0, monthCount = 0, yearCount = 0;
            const contributions = {}; // Map: "YYYY-MM-DD" -> Count

            // Gunakan cache data yang sudah diload
            allDataCache.forEach(item => {
                const date = new Date(item.timestamp);
                const dateStr = date.toISOString().split('T')[0];
                
                // Isi Map Contribution
                contributions[dateStr] = (contributions[dateStr] || 0) + 1;

                // Hitung Counter
                const diffTime = Math.abs(today - date);
                const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24)); 
                
                if (diffDays <= 7) weekCount++;
                if (date.getMonth() === today.getMonth() && date.getFullYear() === today.getFullYear()) monthCount++;
                if (date.getFullYear() === today.getFullYear()) yearCount++;
            });

            // Update Angka
            document.getElementById('statWeek').innerText = weekCount;
            document.getElementById('statMonth').innerText = monthCount;
            document.getElementById('statYear').innerText = yearCount;

            // Render Grid Heatmap (52 Weeks x 7 Days)
            renderContributionGraph(contributions);
        };

        function renderContributionGraph(dataMap) {
            const graph = document.getElementById('contributionGraph');
            graph.innerHTML = '';
            
            // Kita butuh 52 minggu ke belakang dari hari ini
            const today = new Date();
            const startDate = new Date();
            startDate.setDate(today.getDate() - 365);
            
            // Loop 52 minggu (kolom)
            for (let w = 0; w < 53; w++) {
                const col = document.createElement('div');
                col.className = 'flex flex-col gap-1';
                
                // Loop 7 hari (baris) per minggu
                for (let d = 0; d < 7; d++) {
                    const cellDate = new Date(startDate);
                    cellDate.setDate(startDate.getDate() + (w * 7) + d);
                    
                    const dateStr = cellDate.toISOString().split('T')[0];
                    const count = dataMap[dateStr] || 0;
                    
                    // Tentukan Warna
                    let colorClass = 'bg-slate-800 border-slate-700'; // 0 data
                    if (count > 0) colorClass = 'bg-indigo-900 border-indigo-800';
                    if (count > 5) colorClass = 'bg-indigo-700 border-indigo-600';
                    if (count > 15) colorClass = 'bg-indigo-500 border-indigo-400';
                    if (count > 30) colorClass = 'bg-cyan-400 shadow-[0_0_5px_cyan] border-cyan-300';

                    const cell = document.createElement('div');
                    cell.className = `w-3 h-3 rounded-sm border ${colorClass} relative contrib-cell transition-all hover:scale-125 hover:z-20`;
                    cell.setAttribute('data-title', `${dateStr}: ${count} data`);
                    
                    col.appendChild(cell);
                }
                graph.appendChild(col);
            }
        }

        // --- FILTER DATE RANGE ---
        window.applyDateFilter = () => loadData();
        
        window.resetTo3Days = () => {
            document.getElementById('filterStartDate').value = '';
            document.getElementById('filterEndDate').value = '';
            loadData();
        };

        // --- STANDARD LOGIC ---
        document.getElementById('smartRawData').addEventListener('input', function() { document.getElementById('countRaw').innerText = this.value.split('\n').filter(l=>l.trim()!=='').length; });
        document.getElementById('bulkMaps').addEventListener('input', function() { document.getElementById('countMaps').innerText = this.value.split('\n').filter(l=>l.trim()!=='').length; });
        document.getElementById('clearBtn').addEventListener('click', (e) => { e.preventDefault(); document.getElementById('mitraForm').reset(); });

        // === SMART COPY INTERCEPTOR (SEPARATE COLUMNS) ===
        document.addEventListener('copy', function(e) {
            const selection = window.getSelection();
            if (selection.rangeCount === 0) return;
            const rows = document.querySelectorAll('#tableBody tr');
            let clipboardText = ""; let rowsCopied = 0;
            
            rows.forEach(row => {
                if (selection.containsNode(row, true)) {
                    const nameCell = row.querySelector('.col-name');
                    const waCell = row.querySelector('.col-wa');
                    
                    let lineParts = [];
                    // Cek jika Kolom NAMA terpilih
                    if (nameCell && selection.containsNode(nameCell, true)) {
                         lineParts.push(nameCell.innerText.trim().replace(/[\t\n\r]+/g, ' '));
                    }
                    // Cek jika Kolom WA terpilih
                    if (waCell && selection.containsNode(waCell, true)) {
                         lineParts.push(waCell.innerText.trim().replace(/[\t\n\r]+/g, ''));
                    }
                    
                    // Gabungkan jika (mungkin) user memblok 2 kolom sekaligus, tapi defaultnya terpisah
                    if (lineParts.length > 0) {
                        clipboardText += lineParts.join('\t') + '\n';
                        rowsCopied++;
                    }
                }
            });

            if (rowsCopied > 0) { 
                e.preventDefault(); 
                e.clipboardData.setData('text/plain', clipboardText); 
                const btn = document.getElementById('totalDataCount');
                const oldText = btn.innerText;
                btn.innerText = `‚úÖ Tersalin ${rowsCopied} Data!`;
                setTimeout(() => btn.innerText = oldText, 2500);
            }
        });

        // --- SELECTION & STATUS ---
        window.toggleSelect = (id, index, event) => {
            const checkbox = document.getElementById(`cb-${id}`);
            if(event.shiftKey && lastCheckedIndex !== null) {
                const start = Math.min(lastCheckedIndex, index), end = Math.max(lastCheckedIndex, index);
                const targetState = document.getElementById(`cb-${renderedItems[lastCheckedIndex].id}`).checked;
                for(let i=start; i<=end; i++) {
                    const item = renderedItems[i];
                    if(item) {
                        const cb = document.getElementById(`cb-${item.id}`);
                        if(cb) { cb.checked = targetState; targetState ? selectedIds.add(item.id) : selectedIds.delete(item.id); updateRowVisual(item.id, targetState); }
                    }
                }
            } else { checkbox.checked ? selectedIds.add(id) : selectedIds.delete(id); updateRowVisual(id, checkbox.checked); lastCheckedIndex = index; }
            updateActionBar();
        };

        window.toggleSelectAll = (master) => {
            renderedItems.forEach(item => {
                const cb = document.getElementById(`cb-${item.id}`);
                if(cb) { cb.checked = master.checked; master.checked ? selectedIds.add(item.id) : selectedIds.delete(item.id); updateRowVisual(item.id, master.checked); }
            });
            updateActionBar();
        };

        window.clearSelection = () => { document.getElementById('checkAll').checked = false; toggleSelectAll(document.getElementById('checkAll')); };
        function updateRowVisual(id, sel) { const row = document.getElementById(`row-${id}`); if(row) sel ? row.classList.add('row-selected') : row.classList.remove('row-selected'); }
        function updateActionBar() {
            const bar = document.getElementById('selectionActionBar');
            document.getElementById('selCountVal').innerText = selectedIds.size;
            selectedIds.size > 0 ? (bar.classList.remove('hidden'), bar.classList.remove('translate-y-2')) : (bar.classList.add('translate-y-2'), setTimeout(()=>bar.classList.add('hidden'),200));
        }

        window.bulkDelete = async () => { if(confirm(`Hapus ${selectedIds.size} data?`)) { const u={}; selectedIds.forEach(id=>u[`mitra/${id}`]=null); await update(ref(db), u); selectedIds.clear(); loadData(); } };
        window.bulkToggleStatus = async () => { 
            const u={}; let c=0; selectedIds.forEach(id=>{ if(renderedItems.find(x=>x.id===id)?.status==='contacted') c++; });
            const s = c > selectedIds.size/2 ? 'new' : 'contacted';
            selectedIds.forEach(id=>u[`mitra/${id}/status`]=s); await update(ref(db), u); selectedIds.clear(); loadData();
        };

        window.deleteItem = async (id) => { if(confirm('Hapus?')) { await remove(ref(db, 'mitra/'+id)); loadData(); } };
        window.toggleStatus = async (id, s) => { await update(ref(db, 'mitra/'+id), {status: s==='contacted'?'new':'contacted'}); loadData(); };
        
        // --- COPY 10 FUNCTIONALITY (UPDATED: SUPPORT TYPE) ---
        window.copyBatch = async (startIndex, count, check, type) => {
            const itemsToProcess = renderedItems.slice(startIndex, startIndex + count);
            if (itemsToProcess.length === 0) return;

            // Map content based on type ('name' or 'wa')
            const textToCopy = itemsToProcess.map(item => {
                if (type === 'name') return item.nama_usaha;
                return item.wa_display; // default 'wa'
            }).join('\n');
            
            await navigator.clipboard.writeText(textToCopy);
            
            if (check) {
                const updates = {};
                itemsToProcess.forEach(item => { updates[`mitra/${item.id}/status`] = 'contacted'; });
                try {
                    await update(ref(db), updates);
                    loadData(); 
                    alert(`‚úÖ Berhasil copy & tandai ${itemsToProcess.length} data!`);
                } catch(e) { alert('Gagal update: ' + e.message); }
            } else {
                const btn = document.getElementById('totalDataCount');
                const oldText = btn.innerText;
                btn.innerText = `üìã Tersalin ${itemsToProcess.length} (${type === 'name' ? 'Nama' : 'WA'})!`;
                setTimeout(() => btn.innerText = oldText, 2000);
            }
        };

        // --- DATA LOADING & FILTERING ---
        document.getElementById('mitraForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            // ... (Kode submit sama seperti v3.6, diringkas) ...
            const btn = document.getElementById('btnSubmit'); btn.disabled=true;
            const rawLines = document.getElementById('smartRawData').value.split('\n').filter(l=>l.trim());
            const mapsLines = document.getElementById('bulkMaps').value.split('\n').filter(l=>l.trim());
            const loc = document.getElementById('generalLoc').value;
            const batchId = Date.now(); const today = getTodayDate();
            
            if(mapsLines.length && mapsLines.length!==rawLines.length) { alert('Jumlah baris maps beda!'); btn.disabled=false; return; }

            for(let i=0; i<rawLines.length; i++) {
                let parts = rawLines[i].split('\t'); if(parts.length<2) parts=rawLines[i].split(',');
                const wa = sanitizePhoneNumber(parts[1]?.trim());
                if(wa) {
                    try {
                        const s = await get(child(ref(db), `mitra/${wa}`));
                        if(!s.exists()) await set(ref(db, `mitra/${wa}`), {
                            nama_usaha: parts[0]?.trim()||'No Name', wa_display: parts[1]?.trim(), maps: mapsLines[i]?.trim()||'',
                            lokasi_wilayah: loc, tanggal_input: today, timestamp: Date.now(), batch_id: batchId, status: 'new'
                        });
                    } catch(e){}
                }
            }
            btn.disabled=false; document.getElementById('mitraForm').reset(); loadData();
        });

        window.loadData = async function() {
            const tableBody = document.getElementById('tableBody');
            const startF = document.getElementById('filterStartDate').value;
            const endF = document.getElementById('filterEndDate').value;
            const viewTxt = document.getElementById('viewModeText');
            const batchList = document.getElementById('batchListContainer');
            
            tableBody.innerHTML = `<tr><td colspan="8" class="p-8 text-center text-indigo-400 animate-pulse">Scanning...</td></tr>`;

            try {
                const snapshot = await get(ref(db, 'mitra'));
                allDataCache = []; // Reset Global Cache
                renderedItems = []; selectedIds.clear(); updateActionBar(); batchList.innerHTML = '';

                if (snapshot.exists()) {
                    const data = snapshot.val();
                    allDataCache = Object.values(data); // Simpan ke cache untuk statistik
                    
                    // Filtering
                    let filtered = allDataCache.sort((a,b) => b.timestamp - a.timestamp);
                    const threeDaysAgo = new Date(); threeDaysAgo.setDate(threeDaysAgo.getDate()-3); threeDaysAgo.setHours(0,0,0,0);

                    if (startF && endF) {
                        viewTxt.innerText = `Data: ${startF} s/d ${endF}`;
                        const sDate = new Date(startF); const eDate = new Date(endF); eDate.setHours(23,59,59);
                        filtered = filtered.filter(i => { const d = new Date(i.timestamp); return d >= sDate && d <= eDate; });
                    } else {
                        viewTxt.innerText = `Data 3 Hari Terakhir (Default)`;
                        filtered = filtered.filter(i => new Date(i.timestamp) >= threeDaysAgo);
                    }

                    // Render Table
                    if(filtered.length === 0) { tableBody.innerHTML = `<tr><td colspan="8" class="p-8 text-center text-slate-500">Tidak ada data.</td></tr>`; return; }
                    
                    const batches = {};
                    let count = 0;
                    tableBody.innerHTML = '';

                    filtered.forEach(item => {
                        count++;
                        renderedItems.push(item);
                        renderedItems[count-1].id = sanitizePhoneNumber(item.wa_display);
                        
                        // Batch Logic
                        if(item.batch_id) {
                            if(!batches[item.batch_id]) batches[item.batch_id] = {count:0, time: item.timestamp};
                            batches[item.batch_id].count++;
                        }

                        const isContacted = item.status === 'contacted';
                        const rowClass = isContacted ? 'row-contacted' : 'row-new';
                        const btnIcon = isContacted ? '‚úì' : '‚úï';
                        const btnClass = isContacted ? 'bg-emerald-500/20 text-emerald-400' : 'bg-red-500/10 text-red-400 hover:bg-emerald-500 hover:text-white hover:content-["‚úì"]';
                        const itemId = sanitizePhoneNumber(item.wa_display);
                        const dateStr = new Date(item.timestamp).toLocaleDateString('id-ID', {day:'numeric', month:'short'});
                        const timeStr = new Date(item.timestamp).toLocaleTimeString('id-ID', {hour:'2-digit', minute:'2-digit'});
                        const index = count - 1; 

                        tableBody.insertAdjacentHTML('beforeend', `
                            <tr id="row-${itemId}" class="${rowClass} hover:bg-indigo-600/10 border-b border-indigo-500/10 transition-colors group">
                                <td class="p-2 text-center"><input type="checkbox" id="cb-${itemId}" onclick="toggleSelect('${itemId}', ${index}, event)"></td>
                                <td class="p-2 text-center text-slate-500 text-[10px] no-select">${count}</td>
                                <td class="p-2 text-center"><button onclick="toggleStatus('${itemId}','${item.status}')" class="w-6 h-6 rounded flex items-center justify-center transition-all ${btnClass}">${btnIcon}</button></td>
                                <td class="p-2 text-[10px] text-indigo-300 whitespace-nowrap no-select">${dateStr} (${timeStr})</td>
                                <td class="p-2 text-[10px] text-cyan-200 no-select max-w-[100px] truncate">${item.lokasi_wilayah||'-'}</td>
                                
                                <!-- KOLOM NAMA (Sekarang Bisa Dicopy + Hover Action) -->
                                <td class="p-2 selectable col-name text-white font-bold text-[11px] border-l border-indigo-500/10 pl-3 relative cell-container group/name">
                                    ${item.nama_usaha}
                                    <!-- HOVER ACTIONS NAMA -->
                                    <div class="hover-actions absolute right-0 top-1/2 -translate-y-1/2 flex gap-1 z-10 bg-slate-900/90 p-1 rounded-lg border border-indigo-500/50 shadow-lg">
                                        <button onclick="copyBatch(${index}, 10, false, 'name')" class="w-6 h-6 flex items-center justify-center bg-cyan-600 hover:bg-cyan-500 text-white rounded text-[9px] font-bold" title="Copy 10 Nama">üìã</button>
                                    </div>
                                </td>
                                
                                <!-- KOLOM WA (Container untuk Hover Buttons) -->
                                <td class="p-2 border-r border-indigo-500/10 pr-3 relative cell-container group/wa">
                                    <span class="selectable col-wa text-emerald-400 font-mono text-[10px] block">${item.wa_display}</span>
                                    
                                    <!-- HOVER ACTIONS WA -->
                                    <div class="hover-actions absolute right-0 top-1/2 -translate-y-1/2 flex gap-1 z-10 bg-slate-900/90 p-1 rounded-lg border border-indigo-500/50 shadow-lg">
                                        <button onclick="copyBatch(${index}, 10, false, 'wa')" class="w-6 h-6 flex items-center justify-center bg-indigo-600 hover:bg-indigo-500 text-white rounded text-[9px] font-bold" title="Copy 10 WA">üìã</button>
                                        <button onclick="copyBatch(${index}, 10, true, 'wa')" class="w-6 h-6 flex items-center justify-center bg-emerald-600 hover:bg-emerald-500 text-white rounded text-[9px] font-bold" title="Copy & Cek 10 WA">‚úÖ</button>
                                    </div>
                                </td>

                                <td class="p-2 text-center flex justify-center gap-2 no-select">
                                    <a href="${item.maps}" target="_blank" class="w-6 h-6 rounded bg-indigo-500/20 text-indigo-300 flex items-center justify-center hover:bg-indigo-500 hover:text-white">‚û§</a>
                                    <button onclick="deleteItem('${itemId}')" class="w-6 h-6 rounded bg-red-500/20 text-red-300 flex items-center justify-center hover:bg-red-500 hover:text-white">üóë</button>
                                </td>
                            </tr>
                        `);
                    });

                    // Render Batches
                    const batchKeys = Object.keys(batches).sort((a,b)=>b-a);
                    if(batchKeys.length) {
                        batchKeys.forEach(bid => {
                            const b = batches[bid];
                            const d = new Date(b.time);
                            batchList.insertAdjacentHTML('beforeend', `<div class="bg-indigo-900/40 border border-indigo-500/30 p-2 rounded mb-2 flex justify-between items-center group"><div class="text-[10px] text-indigo-300 font-mono">${d.toLocaleDateString()} | ${d.toLocaleTimeString()} <br> <span class="text-white font-bold">${b.count} DATA</span></div><button onclick="deleteBatch('${bid}', ${b.count})" class="text-[9px] bg-red-500/20 hover:bg-red-500 text-red-300 hover:text-white px-2 py-1 rounded">HAPUS</button></div>`);
                        });
                    } else batchList.innerHTML = `<p class="text-[10px] text-slate-500 text-center mt-4">Tidak ada batch.</p>`;

                    document.getElementById('totalDataCount').innerText = `Total: ${count}`;
                } else { tableBody.innerHTML = `<tr><td colspan="8" class="p-8 text-center text-slate-500">Database kosong.</td></tr>`; }
            } catch(e) { console.error(e); }
        }

        // Init: Load notes first as default tab
        loadNotes();
        loadData();
    </script>
</body>
</html>
